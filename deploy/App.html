<!DOCTYPE html>
<html>
<head>
    <title>settings-sample-app</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:{},config:{defaultSettings:{itemtype:"Initiative",items:"",unittype:"Count"}},getSettingsFields:function(){return[{name:"itemtype",xtype:"rallytextfield",label:"Item Type eg. 'Initiaitve'"},{name:"items",xtype:"rallytextfield",label:"Portfolio Items (comma separated)"},{name:"unittype",xtype:"rallytextfield",label:"'Points' or 'Count'"}]},launch:function(){console.log("launch"),app=this;var items=app.getSetting("items").split(",");app.itemtype=app.getSetting("itemtype");var unittype=app.getSetting("unittype");if(items=""!=items?items:["I2921","I2912","I2968","I2962"],""!=items){var configs=_.map(items,function(item){return{model:"PortfolioItem/"+app.itemtype,fetch:["FormattedID","ObjectID","Name","PlannedStartDate","PlannedEndDate"],filters:[{property:"FormattedID",operator:"=",value:item}]}});app.myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),app.myMask.show(),async.map(configs,app.wsapiQuery,function(err,results){var pis=_.map(results,function(r){return r[0]});console.log("pis",pis),app.validateItems(items,pis)!==!1&&async.map([items],app.snapshotquery,function(err,results){console.log("snapshots",results[0].length);var renderer=Ext.create("ChartRenderer",{items:pis,snapshots:results[0]}),chart=app.down("#chart1");null!==chart&&chart.removeAll(),chart=renderer.createChart("chart1","Initiative Progress"),app.add(chart),chart=app.down("#chart1");var p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()}),app.myMask.hide()})})}},validateItems:function(ids,items){var valid=!0;return(null===items||void 0===items)&&(console.log("items not found"),app.myMask.hide(),Rally.ui.notify.Notifier.show({message:"Items Not found!"}),valid=!1),_.each(items,function(item,x){(void 0===item||null===item)&&(console.log("id not found",ids[x]),app.myMask.hide(),Rally.ui.notify.Notifier.show({message:ids[x]+" Not found!"}),valid=!1),void 0!==item&&(null===item.get("PlannedStartDate")||null===item.get("PlannedEndDate"))&&(console.log("no start or end date ",ids[x]),app.myMask.hide(),Rally.ui.notify.Notifier.show({message:ids[x]+" does not have a planned start or end date!"}),valid=!1)}),valid},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},snapshotquery:function(items,callback){console.log("Snapshotquery for Items",items);var storeConfig={find:{_TypeHierarchy:{$in:["PortfolioItem/"+app.itemtype]},FormattedID:{$in:items},_ProjectHierarchy:{$in:app.getContext().getProject().ObjectID}},autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:["FormattedID","_UnformattedID","ObjectID","_TypeHierarchy","PreliminaryEstimate","LeafStoryCount","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal","AcceptedLeafStoryCount","PercentDoneByStoryCount","Name"],hydrate:["_TypeHierarchy"]};storeConfig.find.FormattedID={$in:items},storeConfig.listeners={scope:this,load:function(store,data,success){callback(null,data)}};var snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)}});
                Ext.define("ChartRenderer",function(){var self;return{config:{items:[],snapshots:[]},constructor:function(config){return self=this,this.initConfig(config),this},getCalculator:function(){return Ext.define("MyBurnCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",acceptedData:[],pointsOffset:[],getMetrics:function(){var metrics=[];return _.each(self.items,function(item){metrics.push({as:item.get("FormattedID")+"-"+"Count",f:"filteredSum",field:"LeafStoryCount",filterField:"FormattedID",filterValues:[item.get("FormattedID")],start:item.get("PlannedStartDate"),end:item.get("PlannedEndDate")}),metrics.push({as:item.get("FormattedID")+"-"+"Accepted",f:"filteredSum",field:"AcceptedLeafStoryCount",filterField:"FormattedID",filterValues:[item.get("FormattedID")],start:item.get("PlannedStartDate"),end:item.get("PlannedEndDate")})}),metrics.push({as:"Total-Count",f:"sum",field:"LeafStoryCount"}),metrics.push({as:"Total-Accepted",f:"sum",field:"AcceptedLeafStoryCount"}),metrics},projectValue:function(start,end,itemid,row,index,summaryMetrics,seriesData){var that=this;that.acceptedData[itemid]=void 0==that.acceptedData[itemid]||null==that.acceptedData[itemid]?[]:that.acceptedData[itemid];var ad=that.acceptedData[itemid];if(0===index){datesData=_.pluck(seriesData,"label");var today=new Date,li=datesData.length-1;ad=_.pluck(seriesData,itemid+"-Accepted"),ad=_.filter(ad,function(d,i){return null!=d&&today>new Date(Date.parse(datesData[i]))});var lastAccepted=ad[ad.length-1],lastProjected=linearProject(ad,ad.length-1);that.pointsOffset[itemid]=lastAccepted-lastProjected,that.acceptedData[itemid]=ad}var y=linearProject(ad,index)+that.pointsOffset[itemid];if(null!=start&&null!=end){var d=new Date(Date.parse(seriesData[index].label));if(start>d||d>end)return null}return Math.round(100*y)/100},getDerivedFieldsAfterSummary:function(){var that=this,fields=_.map(self.items,function(item){var fieldMetric={itemid:item.get("FormattedID"),as:item.get("FormattedID")+"-Projection",f:function(row,index,summaryMetrics,seriesData){var id=this.itemid,item=_.find(self.items,function(i){return i.get("FormattedID")===id}),pstart=null!=item?item.get("PlannedStartDate"):null,pend=null!=item?item.get("PlannedEndDate"):null;return that.projectValue(pstart,pend,this.itemid,row,index,summaryMetrics,seriesData)}};return fieldMetric});return fields.push({as:"Total-Projection",f:function(row,index,summaryMetrics,seriesData){return that.projectValue(null,null,"Total",row,index,summaryMetrics,seriesData)}}),fields}}),Ext.create("MyBurnCalculator")},getChartConfig:function(){var lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=_.map(self.snapshots,function(d){return d.data}),calc=self.getCalculator(),config={deriveFieldsOnInput:[],metrics:calc.getMetrics(),summaryMetricsConfig:[],deriveFieldsAfterSummary:calc.getDerivedFieldsAfterSummary(),granularity:lumenize.Time.DAY,tz:"America/New_York",holidays:[],workDays:"Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday"},start=_.min(_.map(self.items,function(i){return i.get("PlannedStartDate")})),end=_.max(_.map(self.items,function(i){return i.get("PlannedEndDate")})),startOnISOString=new lumenize.Time(start).getISOStringInTZ(config.tz),upToDateISOString=new lumenize.Time(end).getISOStringInTZ(config.tz),calculator=new lumenize.TimeSeriesCalculator(config);calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[{name:"label"}];_.each(_.map(calc.getMetrics(),function(m){return{visible:"Total"!=m.as.split("-")[0]?!1:!0,name:m.as,type:"line",thetitle:m.thetitle}}),function(c){hcConfig.push(c)}),_.each(_.map(config.deriveFieldsAfterSummary,function(m){return{visible:"Total"!=m.as.split("-")[0]?!1:!0,name:m.as,type:"line",dashStyle:"dash"}}),function(c){hcConfig.push(c)});var hc=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig),metrics=calc.getMetrics();return _.each(metrics,function(m,i){var h=hc[i+1];_.each(h.data,function(data,x){var d=Date.parse(hc[0].data[x]);(m.start>d||d>m.end)&&(h.data[x]=null)})}),hc},createChart:function(id,title){var series=self.getChartConfig(),tickInterval=140>=series[1].data.length?7:series[1].data.length/10,extChart=Ext.create("Rally.ui.chart.Chart",{listeners:{},columnWidth:1,itemId:id,chartData:{categories:series[0].data,series:series.slice(1,series.length)},chartConfig:{chart:{},title:{style:{fontSize:"10px"},text:title,x:-20},plotOptions:{line:{events:{legendItemClick:function(a,b,c){var prefix=this.name.split("-")[0],series=this.chart.series;_.each(series,function(s,i){var otherPrefix=s.name.split("-")[0];prefix===otherPrefix?s.show():s.hide()}),a.preventDefault();var item=_.find(self.items,function(i){return i.get("FormattedID")===prefix});this.chart.setTitle({text:null!=item?item.get("Name"):"Total"})}}},series:{marker:{radius:2}}},xAxis:{tickInterval:tickInterval,type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%b %d",Date.parse(this.value))}}},yAxis:{title:{text:"count"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{},legend:{align:"center",verticalAlign:"bottom"}}});return extChart}}});
                (function(){function r(e){var n=!1;return function(){if(n)throw Error("Callback was already called.");n=!0,e.apply(t,arguments)}}var e={},t,n;t=this,null!=t&&(n=t.async),e.noConflict=function(){return t.async=n,e};var i=function(e,t){if(e.forEach)return e.forEach(t);for(var n=0;e.length>n;n+=1)t(e[n],n,e)},s=function(e,t){if(e.map)return e.map(t);var n=[];return i(e,function(e,r,i){n.push(t(e,r,i))}),n},o=function(e,t,n){return e.reduce?e.reduce(t,n):(i(e,function(e,r,i){n=t(n,e,r,i)}),n)},u=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t};"undefined"!=typeof process&&process.nextTick?(e.nextTick=process.nextTick,e.setImmediate="undefined"!=typeof setImmediate?function(e){setImmediate(e)}:e.nextTick):"function"==typeof setImmediate?(e.nextTick=function(e){setImmediate(e)},e.setImmediate=e.nextTick):(e.nextTick=function(e){setTimeout(e,0)},e.setImmediate=e.nextTick),e.each=function(e,t,n){if(n=n||function(){},!e.length)return n();var s=0;i(e,function(i){t(i,r(function(t){t?(n(t),n=function(){}):(s+=1,s>=e.length&&n(null))}))})},e.forEach=e.each,e.eachSeries=function(e,t,n){if(n=n||function(){},!e.length)return n();var r=0,i=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r>=e.length?n(null):i())})};i()},e.forEachSeries=e.eachSeries,e.eachLimit=function(e,t,n,r){var i=a(t);i.apply(null,[e,n,r])},e.forEachLimit=e.eachLimit;var a=function(e){return function(t,n,r){if(r=r||function(){},!t.length||0>=e)return r();var i=0,s=0,o=0;(function u(){if(i>=t.length)return r();for(;e>o&&t.length>s;)s+=1,o+=1,n(t[s-1],function(e){e?(r(e),r=function(){}):(i+=1,o-=1,i>=t.length?r():u())})})()}},f=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.each].concat(n))}},l=function(e,t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[a(e)].concat(n))}},c=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.eachSeries].concat(n))}},h=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n,r){i[e.index]=r,t(n)})},function(e){r(e,i)})};e.map=f(h),e.mapSeries=c(h),e.mapLimit=function(e,t,n,r){return p(t)(e,n,r)};var p=function(e){return l(e,h)};e.reduce=function(t,n,r,i){e.eachSeries(t,function(e,t){r(n,e,function(e,r){n=r,t(e)})},function(e){i(e,n)})},e.inject=e.reduce,e.foldl=e.reduce,e.reduceRight=function(t,n,r,i){var o=s(t,function(e){return e}).reverse();e.reduce(o,n,r,i)},e.foldr=e.reduceRight;var d=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&i.push(e),t()})},function(e){r(s(i.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.filter=f(d),e.filterSeries=c(d),e.select=e.filter,e.selectSeries=e.filterSeries;var v=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||i.push(e),t()})},function(e){r(s(i.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.reject=f(v),e.rejectSeries=c(v);var m=function(e,t,n,r){e(t,function(e,t){n(e,function(n){n?(r(e),r=function(){}):t()})},function(e){r()})};e.detect=f(m),e.detectSeries=c(m),e.some=function(t,n,r){e.each(t,function(e,t){n(e,function(e){e&&(r(!0),r=function(){}),t()})},function(e){r(!1)})},e.any=e.some,e.every=function(t,n,r){e.each(t,function(e,t){n(e,function(e){e||(r(!1),r=function(){}),t()})},function(e){r(!0)})},e.all=e.every,e.sortBy=function(t,n,r){e.map(t,function(e,t){n(e,function(n,r){n?t(n):t(null,{value:e,criteria:r})})},function(e,t){if(e)return r(e);var n=function(e,t){var n=e.criteria,r=t.criteria;return r>n?-1:n>r?1:0};r(null,s(t.sort(n),function(e){return e.value}))})},e.auto=function(t,n){n=n||function(){};var r=u(t);if(!r.length)return n(null);var s={},a=[],f=function(e){a.unshift(e)},l=function(e){for(var t=0;a.length>t;t+=1)if(a[t]===e)return a.splice(t,1),void 0},c=function(){i(a.slice(0),function(e){e()})};f(function(){u(s).length===r.length&&(n(null,s),n=function(){})}),i(r,function(r){var a=t[r]instanceof Function?[t[r]]:t[r],h=function(t){var o=Array.prototype.slice.call(arguments,1);if(1>=o.length&&(o=o[0]),t){var a={};i(u(s),function(e){a[e]=s[e]}),a[r]=o,n(t,a),n=function(){}}else s[r]=o,e.setImmediate(c)},p=a.slice(0,Math.abs(a.length-1))||[],d=function(){return o(p,function(e,t){return e&&s.hasOwnProperty(t)},!0)&&!s.hasOwnProperty(r)};if(d())a[a.length-1](h,s);else{var v=function(){d()&&(l(v),a[a.length-1](h,s))};f(v)}})},e.waterfall=function(t,n){if(n=n||function(){},t.constructor!==Array){var r=Error("First argument to waterfall must be an array of functions");return n(r)}if(!t.length)return n();var i=function(t){return function(r){if(r)n.apply(null,arguments),n=function(){};else{var s=Array.prototype.slice.call(arguments,1),o=t.next();o?s.push(i(o)):s.push(n),e.setImmediate(function(){t.apply(null,s)})}}};i(e.iterator(t))()};var g=function(e,t,n){if(n=n||function(){},t.constructor===Array)e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);1>=n.length&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.each(u(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);1>=i.length&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}};e.parallel=function(t,n){g({map:e.map,each:e.each},t,n)},e.parallelLimit=function(e,t,n){g({map:p(t),each:a(t)},e,n)},e.series=function(t,n){if(n=n||function(){},t.constructor===Array)e.mapSeries(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);1>=n.length&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.eachSeries(u(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);1>=i.length&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}},e.iterator=function(e){var t=function(n){var r=function(){return e.length&&e[n].apply(null,arguments),r.next()};return r.next=function(){return e.length-1>n?t(n+1):null},r};return t(0)},e.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var y=function(e,t,n,r){var i=[];e(t,function(e,t){n(e,function(e,n){i=i.concat(n||[]),t(e)})},function(e){r(e,i)})};e.concat=f(y),e.concatSeries=c(y),e.whilst=function(t,n,r){t()?n(function(i){return i?r(i):(e.whilst(t,n,r),void 0)}):r()},e.doWhilst=function(t,n,r){t(function(i){return i?r(i):(n()?e.doWhilst(t,n,r):r(),void 0)})},e.until=function(t,n,r){t()?r():n(function(i){return i?r(i):(e.until(t,n,r),void 0)})},e.doUntil=function(t,n,r){t(function(i){return i?r(i):(n()?r():e.doUntil(t,n,r),void 0)})},e.queue=function(t,n){function s(t,r,s,o){r.constructor!==Array&&(r=[r]),i(r,function(r){var i={data:r,callback:"function"==typeof o?o:null};s?t.tasks.unshift(i):t.tasks.push(i),t.saturated&&t.tasks.length===n&&t.saturated(),e.setImmediate(t.process)})}void 0===n&&(n=1);var o=0,u={tasks:[],concurrency:n,saturated:null,empty:null,drain:null,push:function(e,t){s(u,e,!1,t)},unshift:function(e,t){s(u,e,!0,t)},process:function(){if(u.concurrency>o&&u.tasks.length){var e=u.tasks.shift();u.empty&&0===u.tasks.length&&u.empty(),o+=1;var n=function(){o-=1,e.callback&&e.callback.apply(e,arguments),u.drain&&0===u.tasks.length+o&&u.drain(),u.process()},i=r(n);t(e.data,i)}},length:function(){return u.tasks.length},running:function(){return o}};return u},e.cargo=function(t,n){var r=!1,o=[],u={tasks:o,payload:n,saturated:null,empty:null,drain:null,push:function(t,r){t.constructor!==Array&&(t=[t]),i(t,function(e){o.push({data:e,callback:"function"==typeof r?r:null}),u.saturated&&o.length===n&&u.saturated()}),e.setImmediate(u.process)},process:function a(){if(!r){if(0===o.length)return u.drain&&u.drain(),void 0;var e="number"==typeof n?o.splice(0,n):o.splice(0),f=s(e,function(e){return e.data});u.empty&&u.empty(),r=!0,t(f,function(){r=!1;var t=arguments;i(e,function(e){e.callback&&e.callback.apply(null,t)}),a()})}},length:function(){return o.length},running:function(){return r}};return u};var b=function(e){return function(t){var n=Array.prototype.slice.call(arguments,1);t.apply(null,n.concat([function(t){var n=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(t?console.error&&console.error(t):console[e]&&i(n,function(t){console[e](t)}))}]))}};e.log=b("log"),e.dir=b("dir"),e.memoize=function(e,t){var n={},r={};t=t||function(e){return e};var i=function(){var i=Array.prototype.slice.call(arguments),s=i.pop(),o=t.apply(null,i);o in n?s.apply(null,n[o]):o in r?r[o].push(s):(r[o]=[s],e.apply(null,i.concat([function(){n[o]=arguments;var e=r[o];delete r[o];for(var t=0,i=e.length;i>t;t++)e[t].apply(null,arguments)}])))};return i.memo=n,i.unmemoized=e,i},e.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},e.times=function(t,n,r){for(var i=[],s=0;t>s;s++)i.push(s);return e.map(i,n,r)},e.timesSeries=function(t,n,r){for(var i=[],s=0;t>s;s++)i.push(s);return e.mapSeries(i,n,r)},e.compose=function(){var t=Array.prototype.reverse.call(arguments);return function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();e.reduce(t,r,function(e,t,r){t.apply(n,e.concat([function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);r(e,t)}]))},function(e,t){i.apply(n,[e].concat(t))})}};var w=function(e,t){var n=function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();return e(t,function(e,t){e.apply(n,r.concat([t]))},i)};if(arguments.length>2){var r=Array.prototype.slice.call(arguments,2);return n.apply(this,r)}return n};e.applyEach=f(w),e.applyEachSeries=c(w),e.forever=function(e,t){function n(r){if(r){if(t)return t(r);throw r}e(n)}n()},"undefined"!=typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof module&&module.exports?module.exports=e:t.async=e})();
                function LineFitter(){this.count=0,this.sumX=0,this.sumX2=0,this.sumXY=0,this.sumY=0}function linearProject(data,x){for(var fitter=new LineFitter,i=0;data.length>i;i++)fitter.add(i,data[i]);return fitter.project(x)}function projectToZero(data,x){for(var start=x;linearProject(data,start)>0;)start+=1;return start}LineFitter.prototype={add:function(x,y){this.count++,this.sumX+=x,this.sumX2+=x*x,this.sumXY+=x*y,this.sumY+=y},project:function(x){var det=this.count*this.sumX2-this.sumX*this.sumX,offset=(this.sumX2*this.sumY-this.sumX*this.sumXY)/det,scale=(this.count*this.sumXY-this.sumX*this.sumY)/det;return offset+x*scale}};

            Rally.launchApp('CustomApp', {
                name:"settings-sample-app",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
